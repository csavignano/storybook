name: storybook
type: drupal11
docroot: web
php_version: "8.3"
webserver_type: nginx-fpm
xdebug_enabled: false
additional_hostnames: []
additional_fqdns: []
database:
    type: mariadb
    version: "10.11"
use_dns_when_possible: true
composer_version: "2"
corepack_enable: true

# Performance optimizations
performance_mode: mutagen

# Resource and cache optimizations
webimage_extra_packages: ["php-apcu", "xdg-utils"]
nodejs_version: "22"
bind_all_interfaces: true

# Codespaces settings
router_http_port: "8080"
router_https_port: "8443"

hooks:
  post-start:
    - exec: |
        curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
        export NVM_DIR="$HOME/.nvm"
        [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
        echo "âœ… NVM installed successfully"
    - exec: |
        if [ ! -d "vendor" ] || [ ! -f "composer.lock" ]; then
          echo "ğŸ“¦ Installing Composer dependencies..."
          composer install --no-interaction --prefer-dist --optimize-autoloader
        else
          echo "â™»ï¸ Checking for composer updates..."
          composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev
        fi
        echo "âœ… Composer setup complete"
    - exec-host: |
        echo "ğŸ”„ Waiting for DDEV to be fully ready..."
        # Check if DDEV is responding
        until ddev describe >/dev/null 2>&1; do
          echo "â³ Waiting for DDEV..."
          sleep 2
        done

        echo "ğŸ“¥ Importing database..."
        if [ -f "db/site.sql.gz" ]; then
          ddev import-db --file=db/site.sql.gz
          echo "âœ… Database imported successfully"
        else
          echo "âŒ Database file not found at db/site.sql.gz"
          echo "âš™ï¸ Running site install..."
          ddev drush site-install -y
        fi

        echo "âš™ï¸ Importing configuration..."
        ddev drush cim -y
        echo "ğŸ§¹ Clearing cache..."
        ddev drush cr
        echo "âœ… Post-start setup complete!"
    - exec: "echo 'âœ… DDEV environment is ready for development'"

  pre-stop:
    - exec-host: |
        echo "ğŸ§¹ Clearing cache before export..."
        ddev drush cr
        echo "âš™ï¸ Exporting configuration..."
        ddev drush cex -y
        echo "ğŸ’¾ Exporting database..."
        mkdir -p db
        ddev drush sql-dump --gzip --result-file=../db/site.sql
        echo "âœ… Pre-stop backup complete!"
